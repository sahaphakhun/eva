<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการวันที่เดโม่ - EVA Cloud Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/thai-fonts.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', 'Sarabun', sans-serif;
            background: #f8f9fa;
        }
        .navbar-brand {
            font-weight: 700;
            color: #667eea !important;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .card-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }
        .table td {
            border: none;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        .btn-sm {
            border-radius: 8px;
            padding: 0.375rem 0.75rem;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
        }
        .stats-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-cloud me-2"></i>
                EVA Cloud Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin">
                    <i class="fas fa-users me-1"></i>
                    ข้อมูลลงทะเบียน
                </a>
                <a class="nav-link active" href="/admin-demo-dates">
                    <i class="fas fa-calendar-alt me-1"></i>
                    จัดการวันที่เดโม่
                </a>
                <span class="navbar-text me-3">
                    <i class="fas fa-user-circle me-2"></i>
                    ผู้ดูแลระบบ
                </span>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    ออกจากระบบ
                </button>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">
                        <i class="fas fa-calendar-alt me-3"></i>
                        จัดการวันที่เดโม่
                    </h1>
                    <p class="mb-0 opacity-75">จัดการวันที่และเวลาสำหรับการสาธิต EVA Cloud</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-lg" onclick="window.location.href='/admin'">
                        <i class="fas fa-arrow-left me-2"></i>
                        กลับไปหน้าข้อมูลลงทะเบียน
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" id="totalDemoDates">0</h3>
                            <p class="mb-0 opacity-75">วันที่เดโม่ทั้งหมด</p>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" id="availableDemoDates">0</h3>
                            <p class="mb-0 opacity-75">วันที่ว่าง</p>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" id="fullDemoDates">0</h3>
                            <p class="mb-0 opacity-75">วันที่เต็ม</p>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" id="totalRegistrations">0</h3>
                            <p class="mb-0 opacity-75">ผู้ลงทะเบียนทั้งหมด</p>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        รายการวันที่เดโม่
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-light btn-sm" onclick="loadDemoDates()">
                            <i class="fas fa-sync-alt me-1"></i>
                            รีเฟรช
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="syncDemoDateCounts()">
                            <i class="fas fa-sync me-1"></i>
                            ซิงค์จำนวนคน
                        </button>
                        <button class="btn btn-info btn-sm" onclick="addSampleDemoDates()">
                            <i class="fas fa-plus-circle me-1"></i>
                            เพิ่มข้อมูลตัวอย่าง
                        </button>
                        <button class="btn btn-success btn-sm" onclick="openAddDemoDateModal()">
                            <i class="fas fa-plus me-1"></i>
                            เพิ่มวันที่เดโม่
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>วันที่เดโม่</th>
                                <th>จำนวนคนสูงสุด</th>
                                <th>จำนวนคนที่ลงทะเบียน/สูงสุด</th>
                                <th>สถานะ</th>
                                <th>วันที่สร้าง</th>
                                <th>การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody id="demoDatesTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Demo Date Modal -->
    <div class="modal fade" id="demoDateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="demoDateModalTitle">เพิ่มวันที่เดโม่</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="demoDateForm">
                        <input type="hidden" id="demoDateId">
                        <div class="mb-3">
                            <label class="form-label">วันที่เดโม่ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="demoDateText" required 
                                   placeholder="เช่น วันที่ 10 ธันวาคม 2567 เวลา 11:00 น.">
                            <div class="form-text">ระบุวันที่และเวลาที่สะดวกสำหรับเดโม่ (เป็นสตริงข้อความ)</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">จำนวนคนสูงสุด <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="demoDateMaxCount" required 
                                   min="1" max="100" placeholder="เช่น 10">
                            <div class="form-text">จำนวนคนสูงสุดที่สามารถลงทะเบียนได้ (จำนวนเต็ม)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveDemoDate()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allDemoDates = [];

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Demo dates page loaded');
            loadDemoDates();
        });

        async function loadDemoDates() {
            try {
                console.log('Loading demo dates...');
                const response = await fetch('/api/demo-dates');
                
                if (response.ok) {
                    allDemoDates = await response.json();
                    console.log('Demo dates loaded:', allDemoDates);
                    displayDemoDates();
                } else {
                    console.error('Failed to load demo dates:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    const tbody = document.getElementById('demoDatesTableBody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <br>
                                เกิดข้อผิดพลาดในการโหลดข้อมูล (${response.status})
                                <br>
                                <small class="text-muted">${errorText}</small>
                                <br>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadDemoDates()">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    ลองใหม่
                                </button>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading demo dates:', error);
                const tbody = document.getElementById('demoDatesTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <br>
                            เกิดข้อผิดพลาดในการเชื่อมต่อ
                            <br>
                            <small class="text-muted">${error.message}</small>
                            <br>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadDemoDates()">
                                <i class="fas fa-sync-alt me-1"></i>
                                ลองใหม่
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        function displayDemoDates() {
            const tbody = document.getElementById('demoDatesTableBody');
            
            // อัปเดตข้อมูลสรุป
            updateDemoDateSummary();
            
            if (allDemoDates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-calendar-times fa-2x mb-2"></i>
                            <br>
                            <strong>ยังไม่มีวันที่เดโม่ที่กำหนดไว้</strong>
                            <br>
                            <small class="text-muted">คลิกปุ่ม "เพิ่มข้อมูลตัวอย่าง" เพื่อเพิ่มข้อมูลทดสอบ หรือ "เพิ่มวันที่เดโม่" เพื่อเพิ่มข้อมูลจริง</small>
                            <br>
                            <div class="mt-3">
                                <button class="btn btn-sm btn-info me-2" onclick="addSampleDemoDates()">
                                    <i class="fas fa-plus-circle me-1"></i>
                                    เพิ่มข้อมูลตัวอย่าง
                                </button>
                                <button class="btn btn-sm btn-success" onclick="openAddDemoDateModal()">
                                    <i class="fas fa-plus me-1"></i>
                                    เพิ่มวันที่เดโม่
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allDemoDates.map(date => {
                const createdAt = date.createdAt ? new Date(date.createdAt).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'ไม่ระบุ';
                
                const currentCount = date.currentCount || 0;
                const remainingSlots = date.maxCount - currentCount;
                const isFull = currentCount >= date.maxCount;
                
                return `
                    <tr>
                        <td>${date.dateText}</td>
                        <td>${date.maxCount}</td>
                        <td>
                            ${currentCount} / ${date.maxCount}
                            <br>
                            <small class="text-muted">เหลือ ${remainingSlots} คน</small>
                        </td>
                        <td>
                            <span class="badge status-badge ${isFull ? 'bg-danger' : 'bg-success'}">
                                ${isFull ? 'เต็ม' : 'ว่าง'}
                            </span>
                        </td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditDemoDateModal('${date._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDemoDate('${date._id}')" 
                                    ${currentCount > 0 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateDemoDateSummary() {
            const totalDemoDates = allDemoDates.length;
            const availableDemoDates = allDemoDates.filter(date => (date.currentCount || 0) < date.maxCount).length;
            const fullDemoDates = allDemoDates.filter(date => (date.currentCount || 0) >= date.maxCount).length;
            const totalRegistrations = allDemoDates.reduce((sum, date) => sum + (date.currentCount || 0), 0);

            document.getElementById('totalDemoDates').textContent = totalDemoDates;
            document.getElementById('availableDemoDates').textContent = availableDemoDates;
            document.getElementById('fullDemoDates').textContent = fullDemoDates;
            document.getElementById('totalRegistrations').textContent = totalRegistrations;
        }

        function openAddDemoDateModal() {
            console.log('Opening add demo date modal...');
            
            try {
                const modalTitle = document.getElementById('demoDateModalTitle');
                const demoDateId = document.getElementById('demoDateId');
                const demoDateText = document.getElementById('demoDateText');
                const demoDateMaxCount = document.getElementById('demoDateMaxCount');
                const modal = document.getElementById('demoDateModal');
                
                if (!modalTitle || !demoDateId || !demoDateText || !demoDateMaxCount || !modal) {
                    console.error('Modal elements not found');
                    alert('เกิดข้อผิดพลาดในการเปิด Modal กรุณารีเฟรชหน้าเว็บ');
                    return;
                }
                
                modalTitle.textContent = 'เพิ่มวันที่เดโม่';
                demoDateId.value = '';
                demoDateText.value = '';
                demoDateMaxCount.value = '';
                
                // ลบข้อมูลปัจจุบันออก
                const modalBody = modal.querySelector('.modal-body');
                const existingInfo = modalBody.querySelector('.alert-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                console.log('Modal opened successfully');
                
            } catch (error) {
                console.error('Error opening modal:', error);
                alert('เกิดข้อผิดพลาดในการเปิด Modal: ' + error.message);
            }
        }

        function openEditDemoDateModal(id) {
            const demoDate = allDemoDates.find(date => date._id === id);
            if (demoDate) {
                document.getElementById('demoDateModalTitle').textContent = 'แก้ไขวันที่เดโม่';
                document.getElementById('demoDateId').value = demoDate._id;
                document.getElementById('demoDateText').value = demoDate.dateText;
                document.getElementById('demoDateMaxCount').value = demoDate.maxCount;
                
                // แสดงข้อมูลปัจจุบัน
                const currentInfo = document.createElement('div');
                currentInfo.className = 'alert alert-info mb-3';
                currentInfo.innerHTML = `
                    <strong>ข้อมูลปัจจุบัน:</strong><br>
                    จำนวนคนที่ลงทะเบียนแล้ว: ${demoDate.currentCount || 0} คน<br>
                    จำนวนคนสูงสุด: ${demoDate.maxCount} คน<br>
                    จำนวนคนที่เหลือ: ${demoDate.maxCount - (demoDate.currentCount || 0)} คน
                `;
                
                const modalBody = document.querySelector('#demoDateModal .modal-body');
                const existingInfo = modalBody.querySelector('.alert-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                modalBody.insertBefore(currentInfo, modalBody.firstChild);
                
                new bootstrap.Modal(document.getElementById('demoDateModal')).show();
            }
        }

        async function saveDemoDate() {
            const id = document.getElementById('demoDateId').value;
            const dateText = document.getElementById('demoDateText').value.trim();
            const maxCount = parseInt(document.getElementById('demoDateMaxCount').value);

            if (!dateText) {
                alert('กรุณากรอกวันที่เดโม่');
                document.getElementById('demoDateText').focus();
                return;
            }

            if (!maxCount || maxCount < 1 || maxCount > 100) {
                alert('กรุณากรอกจำนวนคนสูงสุดที่ถูกต้อง (1-100 คน)');
                document.getElementById('demoDateMaxCount').focus();
                return;
            }

            // ตรวจสอบว่าถ้าเป็นการแก้ไข ไม่ให้ลดจำนวนคนสูงสุดให้น้อยกว่าจำนวนคนที่ลงทะเบียนแล้ว
            if (id) {
                const currentDemoDate = allDemoDates.find(date => date._id === id);
                if (currentDemoDate && maxCount < (currentDemoDate.currentCount || 0)) {
                    alert(`ไม่สามารถลดจำนวนคนสูงสุดได้ เนื่องจากมีผู้ลงทะเบียนแล้ว ${currentDemoDate.currentCount || 0} คน`);
                    document.getElementById('demoDateMaxCount').focus();
                    return;
                }
            }

            try {
                const url = id ? `/api/demo-dates/${id}` : '/api/demo-dates';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dateText, maxCount })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('demoDateModal')).hide();
                    loadDemoDates();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                }
            } catch (error) {
                console.error('Error saving demo date:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        async function deleteDemoDate(id) {
            if (!confirm('คุณแน่ใจหรือไม่ที่จะลบวันที่เดโม่นี้?')) {
                return;
            }

            try {
                const response = await fetch(`/api/demo-dates/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadDemoDates();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'เกิดข้อผิดพลาดในการลบข้อมูล');
                }
            } catch (error) {
                console.error('Error deleting demo date:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        async function syncDemoDateCounts() {
            try {
                const response = await fetch('/api/demo-dates/sync-counts', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadDemoDates();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'เกิดข้อผิดพลาดในการซิงค์จำนวนคน');
                }
            } catch (error) {
                console.error('Error syncing demo date counts:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        async function addSampleDemoDates() {
            if (!confirm('คุณแน่ใจหรือไม่ที่จะเพิ่มข้อมูลวันที่เดโม่ตัวอย่าง? ข้อมูลนี้จะถูกเพิ่มเข้าไปในฐานข้อมูล')) {
                return;
            }

            try {
                const response = await fetch('/api/demo-dates/add-samples', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadDemoDates();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'เกิดข้อผิดพลาดในการเพิ่มข้อมูลตัวอย่าง');
                }
            } catch (error) {
                console.error('Error adding sample demo dates:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        function logout() {
            if (confirm('คุณแน่ใจหรือไม่ที่จะออกจากระบบ?')) {
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>
