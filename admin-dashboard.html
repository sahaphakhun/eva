<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - จัดการข้อมูลลงทะเบียน EVA Cloud</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/thai-fonts.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', 'Sarabun', sans-serif;
            background: #f8f9fa;
        }
        .navbar-brand {
            font-weight: 700;
            color: #667eea !important;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .card-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }
        .table td {
            border: none;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        .btn-sm {
            border-radius: 8px;
            padding: 0.375rem 0.75rem;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
        }
        .search-box {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 0.5rem 1rem;
        }
        .search-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
        }
        .stats-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .export-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-cloud me-2"></i>
                EVA Cloud Admin
            </a>
                    <div class="navbar-nav ms-auto">
            <span class="navbar-text me-3">
                <i class="fas fa-user-circle me-2"></i>
                ผู้ดูแลระบบ
            </span>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                <i class="fas fa-sign-out-alt me-1"></i>
                ออกจากระบบ
            </button>
        </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" id="totalRegistrations">0</h3>
                            <p class="mb-0 opacity-75">ลงทะเบียนทั้งหมด</p>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" id="todayRegistrations">0</h3>
                            <p class="mb-0 opacity-75">ลงทะเบียนวันนี้</p>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" id="thisMonthRegistrations">0</h3>
                            <p class="mb-0 opacity-75">ลงทะเบียนเดือนนี้</p>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" id="pendingRegistrations">0</h3>
                            <p class="mb-0 opacity-75">รอติดต่อกลับ</p>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="registrations-tab" data-bs-toggle="tab" data-bs-target="#registrations" type="button" role="tab" aria-controls="registrations" aria-selected="true">
                    <i class="fas fa-users me-2"></i>
                    ข้อมูลลงทะเบียน
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="demo-dates-tab" data-bs-toggle="tab" data-bs-target="#demo-dates" type="button" role="tab" aria-controls="demo-dates" aria-selected="false">
                    <i class="fas fa-calendar-alt me-2"></i>
                    จัดการวันที่เดโม่
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabContent">
            <!-- Registrations Tab -->
            <div class="tab-pane fade show active" id="registrations" role="tabpanel" aria-labelledby="registrations-tab">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                ข้อมูลลงทะเบียนทั้งหมด
                            </h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-light btn-sm" onclick="exportToCSV()">
                                    <i class="fas fa-download me-1"></i>
                                    Export CSV
                                </button>
                                <button class="btn btn-light btn-sm" onclick="refreshData()">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    รีเฟรช
                                </button>
                            </div>
                        </div>
                    </div>
            <div class="card-body">
                <!-- Search and Filter -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control search-box" id="searchInput" placeholder="ค้นหาชื่อ, อีเมล, หรือบริษัท...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">สถานะทั้งหมด</option>
                            <option value="pending">รอติดต่อกลับ</option>
                            <option value="contacted">ติดต่อแล้ว</option>
                            <option value="demo_scheduled">นัดเดโมแล้ว</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="positionFilter">
                            <option value="">ตำแหน่งทั้งหมด</option>
                            <option value="เจ้าของ">เจ้าของ</option>
                            <option value="ช่างถอดแบบ">ช่างถอดแบบ</option>
                            <option value="จัดซื้อ">จัดซื้อ</option>
                            <option value="บัญชี">บัญชี</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>วันที่ลงทะเบียน</th>
                                <th>ชื่อ-นามสกุล</th>
                                <th>ตำแหน่ง</th>
                                <th>บริษัท</th>
                                <th>เบอร์โทร</th>
                                <th>อีเมล</th>
                                <th>วันที่เดโม่</th>
                                <th>สถานะ</th>
                                <th>การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody id="registrationsTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Demo Dates Tab -->
        <div class="tab-pane fade" id="demo-dates" role="tabpanel" aria-labelledby="demo-dates-tab">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            จัดการวันที่เดโม่
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-light btn-sm" onclick="loadDemoDates()">
                                <i class="fas fa-sync-alt me-1"></i>
                                รีเฟรช
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="syncDemoDateCounts()">
                                <i class="fas fa-sync me-1"></i>
                                ซิงค์จำนวนคน
                            </button>
                            <button class="btn btn-info btn-sm" onclick="addSampleDemoDates()">
                                <i class="fas fa-plus-circle me-1"></i>
                                เพิ่มข้อมูลตัวอย่าง
                            </button>
                            <button class="btn btn-success btn-sm" onclick="openAddDemoDateModal()">
                                <i class="fas fa-plus me-1"></i>
                                เพิ่มวันที่เดโม่
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="testModal()">
                                <i class="fas fa-bug me-1"></i>
                                ทดสอบ Modal
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Summary Cards -->
                    <div class="row mb-3" id="demoDateSummary">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">วันที่เดโม่ทั้งหมด</h5>
                                    <h3 id="totalDemoDates">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">วันที่ว่าง</h5>
                                    <h3 id="availableDemoDates">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">วันที่เต็ม</h5>
                                    <h3 id="fullDemoDates">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">ผู้ลงทะเบียนทั้งหมด</h5>
                                    <h3 id="totalRegistrations">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>วันที่เดโม่</th>
                                    <th>จำนวนคนสูงสุด</th>
                                    <th>จำนวนคนที่ลงทะเบียน/สูงสุด</th>
                                    <th>สถานะ</th>
                                    <th>วันที่สร้าง</th>
                                    <th>การดำเนินการ</th>
                                </tr>
                            </thead>
                            <tbody id="demoDatesTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">อัปเดตสถานะ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="statusUpdateForm">
                        <input type="hidden" id="registrationId">
                        <div class="mb-3">
                            <label class="form-label">สถานะ</label>
                            <select class="form-select" id="newStatus" required>
                                <option value="pending">รอติดต่อกลับ</option>
                                <option value="contacted">ติดต่อแล้ว</option>
                                <option value="demo_scheduled">นัดเดโมแล้ว</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">หมายเหตุ</label>
                            <textarea class="form-control" id="notes" rows="3" placeholder="เพิ่มหมายเหตุ (ไม่บังคับ)"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="updateStatus()">อัปเดต</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Demo Date Modal -->
    <div class="modal fade" id="demoDateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="demoDateModalTitle">เพิ่มวันที่เดโม่</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="demoDateForm">
                        <input type="hidden" id="demoDateId">
                        <div class="mb-3">
                            <label class="form-label">วันที่เดโม่ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="demoDateText" required 
                                   placeholder="เช่น วันที่ 10 เวลา 11โมง, วันที่ 15 เวลา 14.00 น.">
                            <div class="form-text">ระบุวันที่และเวลาที่สะดวกสำหรับเดโม่ (เป็นสตริงข้อความ)</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">จำนวนคนสูงสุด <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="demoDateMaxCount" required 
                                   min="1" max="100" placeholder="เช่น 10">
                            <div class="form-text">จำนวนคนสูงสุดที่สามารถลงทะเบียนได้ (จำนวนเต็ม)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveDemoDate()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ตรวจสอบ Bootstrap loading
        window.addEventListener('load', function() {
            if (typeof bootstrap !== 'undefined') {
                console.log('Bootstrap loaded successfully');
            } else {
                console.error('Bootstrap failed to load');
                alert('เกิดข้อผิดพลาด: Bootstrap ไม่ได้ถูกโหลด กรุณารีเฟรชหน้าเว็บ');
            }
        });
    </script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let allRegistrations = [];

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting to load data...');
            // โหลดข้อมูลทั้งหมด
            loadRegistrations();
            loadStatistics();
            // Load demo dates for reference
            loadDemoDates();
            
            // ตรวจสอบว่าปุ่มมีอยู่หรือไม่
            const addButton = document.querySelector('button[onclick="openAddDemoDateModal()"]');
            const sampleButton = document.querySelector('button[onclick="addSampleDemoDates()"]');
            console.log('Add button found:', addButton);
            console.log('Sample button found:', sampleButton);
        });

        // ฟังก์ชันสำหรับการจัดการข้อมูล (ไม่ต้องตรวจสอบ authentication)

        // Search and filter functionality
        document.getElementById('searchInput').addEventListener('input', filterData);
        document.getElementById('statusFilter').addEventListener('change', filterData);
        document.getElementById('positionFilter').addEventListener('change', filterData);

        async function loadRegistrations() {
            try {
                const response = await fetch('/api/registrations');
                
                if (response.ok) {
                    allRegistrations = await response.json();
                    filterData();
                    loadStatistics();
                } else {
                    console.error('Failed to load registrations');
                }
            } catch (error) {
                console.error('Error loading registrations:', error);
            }
        }

        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const positionFilter = document.getElementById('positionFilter').value;

            let filteredData = allRegistrations.filter(reg => {
                const matchesSearch = !searchTerm || 
                    reg.fullName.toLowerCase().includes(searchTerm) ||
                    reg.email.toLowerCase().includes(searchTerm) ||
                    reg.companyName.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || reg.status === statusFilter;
                const matchesPosition = !positionFilter || reg.position === positionFilter;

                return matchesSearch && matchesStatus && matchesPosition;
            });

            displayRegistrations(filteredData);
        }

        function displayRegistrations(data) {
            const tbody = document.getElementById('registrationsTableBody');
            const itemsPerPage = 10;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = data.slice(startIndex, endIndex);

            totalPages = Math.ceil(data.length / itemsPerPage);

            tbody.innerHTML = pageData.map(reg => `
                <tr>
                    <td>${new Date(reg.createdAt).toLocaleDateString('th-TH')}</td>
                    <td>${reg.title} ${reg.fullName}</td>
                    <td>${reg.position}</td>
                    <td>${reg.companyName}</td>
                    <td>${reg.phone}</td>
                    <td>${reg.email}</td>
                    <td>${reg.demoDateText || '-'}</td>
                    <td>
                        <span class="badge status-badge bg-${getStatusColor(reg.status)}">
                            ${getStatusText(reg.status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openStatusModal('${reg._id}', '${reg.status}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewDetails('${reg._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            generatePagination();
        }

        function getStatusColor(status) {
            switch(status) {
                case 'pending': return 'warning';
                case 'contacted': return 'info';
                case 'demo_scheduled': return 'success';
                default: return 'secondary';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'รอติดต่อกลับ';
                case 'contacted': return 'ติดต่อแล้ว';
                case 'demo_scheduled': return 'นัดเดโมแล้ว';
                default: return 'ไม่ทราบสถานะ';
            }
        }

        function generatePagination() {
            const pagination = document.getElementById('pagination');
            let paginationHTML = '';

            // Previous button
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ก่อนหน้า</a>
                </li>
            `;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            // Next button
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ถัดไป</a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                filterData();
            }
        }

        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics');
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalRegistrations').textContent = stats.total;
                    document.getElementById('todayRegistrations').textContent = stats.today;
                    document.getElementById('thisMonthRegistrations').textContent = stats.thisMonth;
                    document.getElementById('pendingRegistrations').textContent = stats.pending;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function openStatusModal(id, currentStatus) {
            document.getElementById('registrationId').value = id;
            document.getElementById('newStatus').value = currentStatus;
            new bootstrap.Modal(document.getElementById('statusModal')).show();
        }

        async function updateStatus() {
            const id = document.getElementById('registrationId').value;
            const status = document.getElementById('newStatus').value;
            const notes = document.getElementById('notes').value;

            try {
                const response = await fetch(`/api/registrations/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status, notes })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
                    loadRegistrations();
                    loadStatistics();
                } else {
                    alert('เกิดข้อผิดพลาดในการอัปเดตสถานะ');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองใหม่อีกครั้ง');
            }
        }

        function viewDetails(id) {
            const registration = allRegistrations.find(reg => reg._id === id);
            if (registration) {
                alert(`
ข้อมูลลงทะเบียน:
ชื่อ: ${registration.title} ${registration.fullName}
ตำแหน่ง: ${registration.position}
เบอร์โทร: ${registration.phone}
ID Line: ${registration.lineId}
อีเมล: ${registration.email}
บริษัท: ${registration.companyName}
สถานที่ตั้ง: ${registration.companyLocation}
แบรนด์อลูมิเนียม: ${registration.aluminumBrands || 'ไม่ระบุ'}
วันที่เดโม่: ${registration.demoDateText || 'ไม่ระบุ'}
วันที่ลงทะเบียน: ${new Date(registration.createdAt).toLocaleString('th-TH')}
                `);
            }
        }

        function exportToCSV() {
            const headers = ['วันที่ลงทะเบียน', 'คำนำหน้า', 'ชื่อ-นามสกุล', 'ตำแหน่ง', 'เบอร์โทร', 'ID Line', 'อีเมล', 'บริษัท', 'สถานที่ตั้ง', 'แบรนด์อลูมิเนียม', 'วันที่เดโม่', 'สถานะ'];
            const csvContent = [
                headers.join(','),
                ...allRegistrations.map(reg => [
                    new Date(reg.createdAt).toLocaleDateString('th-TH'),
                    reg.title,
                    reg.fullName,
                    reg.position,
                    reg.phone,
                    reg.lineId,
                    reg.email,
                    reg.companyName,
                    reg.companyLocation,
                    reg.aluminumBrands || '',
                    reg.demoDateText || '',
                    getStatusText(reg.status)
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `eva-registrations-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function refreshData() {
            loadRegistrations();
        }

        // Demo Date Management Functions
        let allDemoDates = [];

        async function loadDemoDates() {
            try {
                console.log('Loading demo dates...');
                const response = await fetch('/api/demo-dates');
                
                if (response.ok) {
                    allDemoDates = await response.json();
                    console.log('Demo dates loaded:', allDemoDates);
                    console.log('Number of demo dates:', allDemoDates.length);
                    console.log('Demo dates data:', JSON.stringify(allDemoDates, null, 2));
                    displayDemoDates();
                } else {
                    console.error('Failed to load demo dates:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    const tbody = document.getElementById('demoDatesTableBody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <br>
                                เกิดข้อผิดพลาดในการโหลดข้อมูล (${response.status})
                                <br>
                                <small class="text-muted">${errorText}</small>
                                <br>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadDemoDates()">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    ลองใหม่
                                </button>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading demo dates:', error);
                const tbody = document.getElementById('demoDatesTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <br>
                            เกิดข้อผิดพลาดในการเชื่อมต่อ
                            <br>
                            <small class="text-muted">${error.message}</small>
                            <br>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadDemoDates()">
                                <i class="fas fa-sync-alt me-1"></i>
                                ลองใหม่
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        function displayDemoDates() {
            const tbody = document.getElementById('demoDatesTableBody');
            
            // อัปเดตข้อมูลสรุป
            updateDemoDateSummary();
            
            if (allDemoDates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-calendar-times fa-2x mb-2"></i>
                            <br>
                            <strong>ยังไม่มีวันที่เดโม่ที่กำหนดไว้</strong>
                            <br>
                            <small class="text-muted">คลิกปุ่ม "เพิ่มข้อมูลตัวอย่าง" เพื่อเพิ่มข้อมูลทดสอบ หรือ "เพิ่มวันที่เดโม่" เพื่อเพิ่มข้อมูลจริง</small>
                            <br>
                            <div class="mt-3">
                                <button class="btn btn-sm btn-info me-2" onclick="addSampleDemoDates()">
                                    <i class="fas fa-plus-circle me-1"></i>
                                    เพิ่มข้อมูลตัวอย่าง
                                </button>
                                <button class="btn btn-sm btn-success" onclick="openAddDemoDateModal()">
                                    <i class="fas fa-plus me-1"></i>
                                    เพิ่มวันที่เดโม่
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allDemoDates.map(date => {
                const createdAt = date.createdAt ? new Date(date.createdAt).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'ไม่ระบุ';
                
                const currentCount = date.currentCount || 0;
                const remainingSlots = date.maxCount - currentCount;
                const isFull = currentCount >= date.maxCount;
                
                return `
                    <tr>
                        <td>${date.dateText}</td>
                        <td>${date.maxCount}</td>
                        <td>
                            ${currentCount} / ${date.maxCount}
                            <br>
                            <small class="text-muted">เหลือ ${remainingSlots} คน</small>
                        </td>
                        <td>
                            <span class="badge status-badge ${isFull ? 'bg-danger' : 'bg-success'}">
                                ${isFull ? 'เต็ม' : 'ว่าง'}
                            </span>
                        </td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditDemoDateModal('${date._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDemoDate('${date._id}')" 
                                    ${currentCount > 0 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openAddDemoDateModal() {
            console.log('Opening add demo date modal...');
            
            try {
                const modalTitle = document.getElementById('demoDateModalTitle');
                const demoDateId = document.getElementById('demoDateId');
                const demoDateText = document.getElementById('demoDateText');
                const demoDateMaxCount = document.getElementById('demoDateMaxCount');
                const modal = document.getElementById('demoDateModal');
                
                if (!modalTitle || !demoDateId || !demoDateText || !demoDateMaxCount || !modal) {
                    console.error('Modal elements not found:', {
                        modalTitle: !!modalTitle,
                        demoDateId: !!demoDateId,
                        demoDateText: !!demoDateText,
                        demoDateMaxCount: !!demoDateMaxCount,
                        modal: !!modal
                    });
                    alert('เกิดข้อผิดพลาดในการเปิด Modal กรุณารีเฟรชหน้าเว็บ');
                    return;
                }
                
                modalTitle.textContent = 'เพิ่มวันที่เดโม่';
                demoDateId.value = '';
                demoDateText.value = '';
                demoDateMaxCount.value = '';
                
                // ลบข้อมูลปัจจุบันออก
                const modalBody = modal.querySelector('.modal-body');
                const existingInfo = modalBody.querySelector('.alert-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                console.log('Modal opened successfully');
                
            } catch (error) {
                console.error('Error opening modal:', error);
                alert('เกิดข้อผิดพลาดในการเปิด Modal: ' + error.message);
            }
        }

        function openEditDemoDateModal(id) {
            const demoDate = allDemoDates.find(date => date._id === id);
            if (demoDate) {
                document.getElementById('demoDateModalTitle').textContent = 'แก้ไขวันที่เดโม่';
                document.getElementById('demoDateId').value = demoDate._id;
                document.getElementById('demoDateText').value = demoDate.dateText;
                document.getElementById('demoDateMaxCount').value = demoDate.maxCount;
                
                // แสดงข้อมูลปัจจุบัน
                const currentInfo = document.createElement('div');
                currentInfo.className = 'alert alert-info mb-3';
                currentInfo.innerHTML = `
                    <strong>ข้อมูลปัจจุบัน:</strong><br>
                    จำนวนคนที่ลงทะเบียนแล้ว: ${demoDate.currentCount || 0} คน<br>
                    จำนวนคนสูงสุด: ${demoDate.maxCount} คน<br>
                    จำนวนคนที่เหลือ: ${demoDate.maxCount - (demoDate.currentCount || 0)} คน
                `;
                
                const modalBody = document.querySelector('#demoDateModal .modal-body');
                const existingInfo = modalBody.querySelector('.alert-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                modalBody.insertBefore(currentInfo, modalBody.firstChild);
                
                new bootstrap.Modal(document.getElementById('demoDateModal')).show();
            }
        }

        async function saveDemoDate() {
            const id = document.getElementById('demoDateId').value;
            const dateText = document.getElementById('demoDateText').value.trim();
            const maxCount = parseInt(document.getElementById('demoDateMaxCount').value);

            if (!dateText) {
                alert('กรุณากรอกวันที่เดโม่');
                document.getElementById('demoDateText').focus();
                return;
            }

            if (!maxCount || maxCount < 1 || maxCount > 100) {
                alert('กรุณากรอกจำนวนคนสูงสุดที่ถูกต้อง (1-100 คน)');
                document.getElementById('demoDateMaxCount').focus();
                return;
            }

            // ตรวจสอบว่าถ้าเป็นการแก้ไข ไม่ให้ลดจำนวนคนสูงสุดให้น้อยกว่าจำนวนคนที่ลงทะเบียนแล้ว
            if (id) {
                const currentDemoDate = allDemoDates.find(date => date._id === id);
                if (currentDemoDate && maxCount < (currentDemoDate.currentCount || 0)) {
                    alert(`ไม่สามารถลดจำนวนคนสูงสุดได้ เนื่องจากมีผู้ลงทะเบียนแล้ว ${currentDemoDate.currentCount || 0} คน`);
                    document.getElementById('demoDateMaxCount').focus();
                    return;
                }
            }

            try {
                const url = id ? `/api/demo-dates/${id}` : '/api/demo-dates';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dateText, maxCount })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('demoDateModal')).hide();
                    loadDemoDates();
                    // Reload registrations to update demo date info
                    loadRegistrations();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                }
            } catch (error) {
                console.error('Error saving demo date:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        async function deleteDemoDate(id) {
            if (!confirm('คุณแน่ใจหรือไม่ที่จะลบวันที่เดโม่นี้?')) {
                return;
            }

            try {
                const response = await fetch(`/api/demo-dates/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadDemoDates();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'เกิดข้อผิดพลาดในการลบข้อมูล');
                }
            } catch (error) {
                console.error('Error deleting demo date:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        function updateDemoDateSummary() {
            const totalDemoDates = allDemoDates.length;
            const availableDemoDates = allDemoDates.filter(date => (date.currentCount || 0) < date.maxCount).length;
            const fullDemoDates = allDemoDates.filter(date => (date.currentCount || 0) >= date.maxCount).length;
            const totalRegistrations = allDemoDates.reduce((sum, date) => sum + (date.currentCount || 0), 0);

            // Update summary cards
            const totalDemoDatesElement = document.getElementById('totalDemoDates');
            const availableDemoDatesElement = document.getElementById('availableDemoDates');
            const fullDemoDatesElement = document.getElementById('fullDemoDates');
            const totalRegistrationsElement = document.getElementById('totalRegistrations');

            if (totalDemoDatesElement) totalDemoDatesElement.textContent = totalDemoDates;
            if (availableDemoDatesElement) availableDemoDatesElement.textContent = availableDemoDates;
            if (fullDemoDatesElement) fullDemoDatesElement.textContent = fullDemoDates;
            if (totalRegistrationsElement) totalRegistrationsElement.textContent = totalRegistrations;
        }

        // Load demo dates when switching to demo dates tab
        document.getElementById('demo-dates-tab').addEventListener('click', function() {
            console.log('Demo dates tab clicked');
            loadDemoDates();
        });

        // Test API endpoint directly
        async function testDemoDatesAPI() {
            try {
                console.log('Testing demo dates API...');
                const response = await fetch('/api/demo-dates');
                console.log('API Response status:', response.status);
                console.log('API Response headers:', response.headers);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Response data:', data);
                    console.log('Data type:', typeof data);
                    console.log('Is array:', Array.isArray(data));
                } else {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                }
            } catch (error) {
                console.error('API Test error:', error);
            }
        }

        // Test API on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, testing API...');
            testDemoDatesAPI();
            
            // ตรวจสอบ Bootstrap
            if (typeof bootstrap !== 'undefined') {
                console.log('Bootstrap is loaded');
            } else {
                console.error('Bootstrap is not loaded!');
                alert('เกิดข้อผิดพลาด: Bootstrap ไม่ได้ถูกโหลด กรุณารีเฟรชหน้าเว็บ');
            }
        });

        // Sync demo date counts
        async function syncDemoDateCounts() {
            try {
                const response = await fetch('/api/demo-dates/sync-counts', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadDemoDates(); // Reload the data
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'เกิดข้อผิดพลาดในการซิงค์จำนวนคน');
                }
            } catch (error) {
                console.error('Error syncing demo date counts:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        // Add sample demo dates
        async function addSampleDemoDates() {
            if (!confirm('คุณแน่ใจหรือไม่ที่จะเพิ่มข้อมูลวันที่เดโม่ตัวอย่าง? ข้อมูลนี้จะถูกเพิ่มเข้าไปในฐานข้อมูล')) {
                return;
            }

            try {
                const response = await fetch('/api/demo-dates/add-samples', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadDemoDates(); // Reload the data
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'เกิดข้อผิดพลาดในการเพิ่มข้อมูลตัวอย่าง');
                }
            } catch (error) {
                console.error('Error adding sample demo dates:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        // Test modal function
        function testModal() {
            console.log('Testing modal...');
            alert('ฟังก์ชัน JavaScript ทำงานปกติ');
            
            // ตรวจสอบ Modal elements
            const modal = document.getElementById('demoDateModal');
            const modalTitle = document.getElementById('demoDateModalTitle');
            
            console.log('Modal element:', modal);
            console.log('Modal title element:', modalTitle);
            
            if (modal && modalTitle) {
                alert('Modal elements พบแล้ว - ลองเปิด Modal');
                openAddDemoDateModal();
            } else {
                alert('ไม่พบ Modal elements');
            }
        }
    </script>
</body>
</html>
